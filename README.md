# Intel Skylake SP lost DR6 Microarchitecture bug

This document describes a microarchitecture bug present in the Intel Skylake SP microarchitecture (and potentially later architectures). I reported it to Intel in 2020, but the lack of apparent security impact and lab access restrictions due to Covid caused it to never be fully investigated. I'm documenting it here for others who may be seeing unexpected behaviors on these microarchitectures.

The issue in question arises at the intersection of data watchpoints (DR6 faults), fast-string optimizations and page boundaries, which is somewhat of complicated combination, but can regularly happen in practice, e.g. in debuggers like rr where this issue was originally detected (https://github.com/rr-debugger/rr/issues/2427).

## High Level Impact

In one variant of this issue a DR6 fault triggered by a string instruction (e.g. `rep stosb`) is reported later than documented.
In the more severe variant, the DR6 fault is not triggered at all.

Note that SKX54 is another erratum in the same microarchitecture that causes missing DR6 faults, but the (documented) circumstances that trigger SKX54 are quite different.

## Brief Review of Relevant Microarchitecture Features

### Fast string instructions

Fast string isntructions is a microarchitecture optimization that causes the string instructions (e.g. `rep stosb`) to executed using a microcoded memcpy/memset loop for better efficiency. It is documented in the Intel Architecture Manual, Volume 1. Section 7.3.9.3. and is enabled by BIOS or the kernel by setting the fast-string-enable-bit (IA32_MISC_ENABLE[0] = 1). This optimization has a documented interaction with data watchpoints. To quote the manual:

	With fast-string operation, the processor recognizes interrupts and data breakpoints only on boundaries between these groups.

### Data Breakpoints

The processor data breakpoints (also named DR6 breakpoints after the
register that reports the trap flags), allow the user to watch for memory access and generated a #DB trap when the access matches a
condition specified by the `DR0-DR3` address registers and the `DR7`
enable register.

### TLB miss page walk

The Translation-Lookaside-Buffer (TLB), stores mappings from virtual
addresses to physical addresses for recent access. It is essentially a cache from for the page table. On some architectures (e.g. MIPS), the TLB is the only mechanism provided for virtual-to-physical translation and a TLB miss will trap to the operating system to perform a page table walk to populate the TLB. On x86, page table walking is done in hardware/microcode and is transparent to code running on the CPU.


## Detailed Issue description

Consider a `rep stosb` operation with some initial rdi `I`, of some length `n`, such that the final rdi would be `F`. We then
set a data breakpoint at some address `D` between `I` and `F`. Now, it is well documented that with the fast string optimization, the data breakpoint for `D` may not trigger until the next coalescing boundary (on Skylake up to 128 bytes). This is easily observable and has been the case since the introduction of fast-strings. However, on Skylake SP,
we additionally observe some very strange behavior if `D` and `F` are near a page boundary.
In particular, it appears that if `D` is within 64 bytes of the end of a page and `F` is within 127 bytes of the start of the next page, no interrupt is generated by the data breakpoint until the end of the instruction, up to 190 bytes after the watch point, rather than the typical 128. Further, it appears that if the page on which `F` is located causes a TLB fault, no trap for the data watch point is generated at all. This behavior is not observed in earlier microarchitectures.


## C reproducer

This repository contains a small .c file that will probe various values of `D` and reports whether or not the breakpoint instruction was generated and if was whether or not the trap was reported in dr6.

### Example output on Skylake SP
```
3f f3f 107e YES 1
3f f40 107e YES 128
3f f41 107e YES 127
3f f42 107e YES 126
3f f43 107e YES 125
3f f44 107e YES 124
3f f45 107e YES 123
3f f46 107e YES 122
3f f47 107e YES 121
3f f48 107e YES 120
3f f49 107e YES 119
3f f4a 107e YES 118
3f f4b 107e YES 117
3f f4c 107e YES 116
3f f4d 107e YES 115
3f f4e 107e YES 114
3f f4f 107e YES 113
3f f50 107e YES 112
3f f51 107e YES 111
3f f52 107e YES 110
3f f53 107e YES 109
3f f54 107e YES 108
3f f55 107e YES 107
3f f56 107e YES 106
3f f57 107e YES 105
3f f58 107e YES 104
3f f59 107e YES 103
3f f5a 107e YES 102
3f f5b 107e YES 101
3f f5c 107e YES 100
3f f5d 107e YES 99
3f f5e 107e YES 98
3f f5f 107e YES 97
3f f60 107e YES 96
3f f61 107e YES 95
3f f62 107e YES 94
3f f63 107e YES 93
3f f64 107e YES 92
3f f65 107e YES 91
3f f66 107e YES 90
3f f67 107e YES 89
3f f68 107e YES 88
3f f69 107e YES 87
3f f6a 107e YES 86
3f f6b 107e YES 85
3f f6c 107e YES 84
3f f6d 107e YES 83
3f f6e 107e YES 82
3f f6f 107e YES 81
3f f70 107e YES 80
3f f71 107e YES 79
3f f72 107e YES 78
3f f73 107e YES 77
3f f74 107e YES 76
3f f75 107e YES 75
3f f76 107e YES 74
3f f77 107e YES 73
3f f78 107e YES 72
3f f79 107e YES 71
3f f7a 107e YES 70
3f f7b 107e YES 69
3f f7c 107e YES 68
3f f7d 107e YES 67
3f f7e 107e YES 66
3f f7f 107e YES 65
3f f80 107e YES 64
3f f81 107e YES 63
3f f82 107e YES 62
3f f83 107e YES 61
3f f84 107e YES 60
3f f85 107e YES 59
3f f86 107e YES 58
3f f87 107e YES 57
3f f88 107e YES 56
3f f89 107e YES 55
3f f8a 107e YES 54
3f f8b 107e YES 53
3f f8c 107e YES 52
3f f8d 107e YES 51
3f f8e 107e YES 50
3f f8f 107e YES 49
3f f90 107e YES 48
3f f91 107e YES 47
3f f92 107e YES 46
3f f93 107e YES 45
3f f94 107e YES 44
3f f95 107e YES 43
3f f96 107e YES 42
3f f97 107e YES 41
3f f98 107e YES 40
3f f99 107e YES 39
3f f9a 107e YES 38
3f f9b 107e YES 37
3f f9c 107e YES 36
3f f9d 107e YES 35
3f f9e 107e YES 34
3f f9f 107e YES 33
3f fa0 107e YES 32
3f fa1 107e YES 31
3f fa2 107e YES 30
3f fa3 107e YES 29
3f fa4 107e YES 28
3f fa5 107e YES 27
3f fa6 107e YES 26
3f fa7 107e YES 25
3f fa8 107e YES 24
3f fa9 107e YES 23
3f faa 107e YES 22
3f fab 107e YES 21
3f fac 107e YES 20
3f fad 107e YES 19
3f fae 107e YES 18
3f faf 107e YES 17
3f fb0 107e YES 16
3f fb1 107e YES 15
3f fb2 107e YES 14
3f fb3 107e YES 13
3f fb4 107e YES 12
3f fb5 107e YES 11
3f fb6 107e YES 10
3f fb7 107e YES 9
3f fb8 107e YES 8
3f fb9 107e YES 7
3f fba 107e YES 6
3f fbb 107e YES 5
3f fbc 107e YES 4
3f fbd 107e YES 3
3f fbe 107e YES 2
3f fbf 107e YES 1
3f fc0 107e NO 190!
3f fc1 107e NO 189!
3f fc2 107e NO 188!
3f fc3 107e NO 187!
3f fc4 107e NO 186!
3f fc5 107e NO 185!
3f fc6 107e NO 184!
3f fc7 107e NO 183!
3f fc8 107e NO 182!
3f fc9 107e NO 181!
3f fca 107e NO 180!
3f fcb 107e NO 179!
3f fcc 107e NO 178!
3f fcd 107e NO 177!
3f fce 107e NO 176!
3f fcf 107e NO 175!
3f fd0 107e NO 174!
3f fd1 107e NO 173!
3f fd2 107e NO 172!
3f fd3 107e NO 171!
3f fd4 107e NO 170!
3f fd5 107e NO 169!
3f fd6 107e NO 168!
3f fd7 107e NO 167!
3f fd8 107e NO 166!
3f fd9 107e NO 165!
3f fda 107e NO 164!
3f fdb 107e NO 163!
3f fdc 107e NO 162!
3f fdd 107e NO 161!
3f fde 107e NO 160!
3f fdf 107e NO 159!
3f fe0 107e NO 158!
3f fe1 107e NO 157!
3f fe2 107e NO 156!
3f fe3 107e NO 155!
3f fe4 107e NO 154!
3f fe5 107e NO 153!
3f fe6 107e NO 152!
3f fe7 107e NO 151!
3f fe8 107e NO 150!
3f fe9 107e NO 149!
3f fea 107e NO 148!
3f feb 107e NO 147!
3f fec 107e NO 146!
3f fed 107e NO 145!
3f fee 107e NO 144!
3f fef 107e NO 143!
3f ff0 107e NO 142!
3f ff1 107e NO 141!
3f ff2 107e NO 140!
3f ff3 107e NO 139!
3f ff4 107e NO 138!
3f ff5 107e NO 137!
3f ff6 107e NO 136!
3f ff7 107e NO 135!
3f ff8 107e NO 134!
3f ff9 107e NO 133!
3f ffa 107e NO 132!
3f ffb 107e NO 131!
3f ffc 107e NO 130!
3f ffd 107e NO 129!
3f ffe 107e NO 128
3f fff 107e NO 127
3f 1000 107e YES 1
3f 1001 107e YES 1
3f 1002 107e YES 1
3f 1003 107e YES 1
3f 1004 107e YES 1
3f 1005 107e YES 1
3f 1006 107e YES 1
3f 1007 107e YES 1
3f 1008 107e YES 1
3f 1009 107e YES 1
3f 100a 107e YES 1
3f 100b 107e YES 1
3f 100c 107e YES 1
3f 100d 107e YES 1
3f 100e 107e YES 1
3f 100f 107e YES 1
3f 1010 107e YES 1
3f 1011 107e YES 1
3f 1012 107e YES 1
3f 1013 107e YES 1
3f 1014 107e YES 1
3f 1015 107e YES 1
3f 1016 107e YES 1
3f 1017 107e YES 1
3f 1018 107e YES 1
3f 1019 107e YES 1
3f 101a 107e YES 1
3f 101b 107e YES 1
3f 101c 107e YES 1
3f 101d 107e YES 1
3f 101e 107e YES 1
3f 101f 107e YES 1
3f 1020 107e YES 1
3f 1021 107e YES 1
3f 1022 107e YES 1
3f 1023 107e YES 1
3f 1024 107e YES 1
3f 1025 107e YES 1
3f 1026 107e YES 1
3f 1027 107e YES 1
3f 1028 107e YES 1
3f 1029 107e YES 1
3f 102a 107e YES 1
3f 102b 107e YES 1
3f 102c 107e YES 1
3f 102d 107e YES 1
3f 102e 107e YES 1
3f 102f 107e YES 1
3f 1030 107e YES 1
3f 1031 107e YES 1
3f 1032 107e YES 1
3f 1033 107e YES 1
3f 1034 107e YES 1
3f 1035 107e YES 1
3f 1036 107e YES 1
3f 1037 107e YES 1
3f 1038 107e YES 1
3f 1039 107e YES 1
3f 103a 107e YES 1
3f 103b 107e YES 1
3f 103c 107e YES 1
3f 103d 107e YES 1
3f 103e 107e YES 1
3f 103f 107e YES 1
3f 1040 107e YES 1
3f 1041 107e YES 1
3f 1042 107e YES 1
3f 1043 107e YES 1
3f 1044 107e YES 1
3f 1045 107e YES 1
3f 1046 107e YES 1
3f 1047 107e YES 1
3f 1048 107e YES 1
3f 1049 107e YES 1
3f 104a 107e YES 1
3f 104b 107e YES 1
3f 104c 107e YES 1
3f 104d 107e YES 1
3f 104e 107e YES 1
3f 104f 107e YES 1
3f 1050 107e YES 1
3f 1051 107e YES 1
3f 1052 107e YES 1
3f 1053 107e YES 1
3f 1054 107e YES 1
3f 1055 107e YES 1
3f 1056 107e YES 1
3f 1057 107e YES 1
3f 1058 107e YES 1
3f 1059 107e YES 1
3f 105a 107e YES 1
3f 105b 107e YES 1
3f 105c 107e YES 1
3f 105d 107e YES 1
3f 105e 107e YES 1
3f 105f 107e YES 1
3f 1060 107e YES 1
3f 1061 107e YES 1
3f 1062 107e YES 1
3f 1063 107e YES 1
3f 1064 107e YES 1
3f 1065 107e YES 1
3f 1066 107e YES 1
3f 1067 107e YES 1
3f 1068 107e YES 1
3f 1069 107e YES 1
3f 106a 107e YES 1
3f 106b 107e YES 1
3f 106c 107e YES 1
3f 106d 107e YES 1
3f 106e 107e YES 1
3f 106f 107e YES 1
3f 1070 107e YES 1
3f 1071 107e YES 1
3f 1072 107e YES 1
3f 1073 107e YES 1
3f 1074 107e YES 1
3f 1075 107e YES 1
3f 1076 107e YES 1
3f 1077 107e YES 1
3f 1078 107e YES 1
3f 1079 107e YES 1
3f 107a 107e YES 1
3f 107b 107e YES 1
3f 107c 107e YES 1
3f 107d 107e YES 1
```

Example output on older microarchitectures:

```
3f f3f 107e YES 64
3f f40 107e YES 63
3f f41 107e YES 62
3f f42 107e YES 61
3f f43 107e YES 60
3f f44 107e YES 59
3f f45 107e YES 58
3f f46 107e YES 57
3f f47 107e YES 56
3f f48 107e YES 55
3f f49 107e YES 54
3f f4a 107e YES 53
3f f4b 107e YES 52
3f f4c 107e YES 51
3f f4d 107e YES 50
3f f4e 107e YES 49
3f f4f 107e YES 48
3f f50 107e YES 47
3f f51 107e YES 46
3f f52 107e YES 45
3f f53 107e YES 44
3f f54 107e YES 43
3f f55 107e YES 42
3f f56 107e YES 41
3f f57 107e YES 40
3f f58 107e YES 39
3f f59 107e YES 38
3f f5a 107e YES 37
3f f5b 107e YES 36
3f f5c 107e YES 35
3f f5d 107e YES 34
3f f5e 107e YES 33
3f f5f 107e YES 32
3f f60 107e YES 31
3f f61 107e YES 30
3f f62 107e YES 29
3f f63 107e YES 28
3f f64 107e YES 27
3f f65 107e YES 26
3f f66 107e YES 25
3f f67 107e YES 24
3f f68 107e YES 23
3f f69 107e YES 22
3f f6a 107e YES 21
3f f6b 107e YES 20
3f f6c 107e YES 19
3f f6d 107e YES 18
3f f6e 107e YES 17
3f f6f 107e YES 16
3f f70 107e YES 15
3f f71 107e YES 14
3f f72 107e YES 13
3f f73 107e YES 12
3f f74 107e YES 11
3f f75 107e YES 10
3f f76 107e YES 9
3f f77 107e YES 8
3f f78 107e YES 7
3f f79 107e YES 6
3f f7a 107e YES 5
3f f7b 107e YES 4
3f f7c 107e YES 3
3f f7d 107e YES 2
3f f7e 107e YES 1
3f f7f 107e YES 64
3f f80 107e YES 63
3f f81 107e YES 62
3f f82 107e YES 61
3f f83 107e YES 60
3f f84 107e YES 59
3f f85 107e YES 58
3f f86 107e YES 57
3f f87 107e YES 56
3f f88 107e YES 55
3f f89 107e YES 54
3f f8a 107e YES 53
3f f8b 107e YES 52
3f f8c 107e YES 51
3f f8d 107e YES 50
3f f8e 107e YES 49
3f f8f 107e YES 48
3f f90 107e YES 47
3f f91 107e YES 46
3f f92 107e YES 45
3f f93 107e YES 44
3f f94 107e YES 43
3f f95 107e YES 42
3f f96 107e YES 41
3f f97 107e YES 40
3f f98 107e YES 39
3f f99 107e YES 38
3f f9a 107e YES 37
3f f9b 107e YES 36
3f f9c 107e YES 35
3f f9d 107e YES 34
3f f9e 107e YES 33
3f f9f 107e YES 32
3f fa0 107e YES 31
3f fa1 107e YES 30
3f fa2 107e YES 29
3f fa3 107e YES 28
3f fa4 107e YES 27
3f fa5 107e YES 26
3f fa6 107e YES 25
3f fa7 107e YES 24
3f fa8 107e YES 23
3f fa9 107e YES 22
3f faa 107e YES 21
3f fab 107e YES 20
3f fac 107e YES 19
3f fad 107e YES 18
3f fae 107e YES 17
3f faf 107e YES 16
3f fb0 107e YES 15
3f fb1 107e YES 14
3f fb2 107e YES 13
3f fb3 107e YES 12
3f fb4 107e YES 11
3f fb5 107e YES 10
3f fb6 107e YES 9
3f fb7 107e YES 8
3f fb8 107e YES 7
3f fb9 107e YES 6
3f fba 107e YES 5
3f fbb 107e YES 4
3f fbc 107e YES 3
3f fbd 107e YES 2
3f fbe 107e YES 1
3f fbf 107e YES 64
3f fc0 107e YES 63
3f fc1 107e YES 62
3f fc2 107e YES 61
3f fc3 107e YES 60
3f fc4 107e YES 59
3f fc5 107e YES 58
3f fc6 107e YES 57
3f fc7 107e YES 56
3f fc8 107e YES 55
3f fc9 107e YES 54
3f fca 107e YES 53
3f fcb 107e YES 52
3f fcc 107e YES 51
3f fcd 107e YES 50
3f fce 107e YES 49
3f fcf 107e YES 48
3f fd0 107e YES 47
3f fd1 107e YES 46
3f fd2 107e YES 45
3f fd3 107e YES 44
3f fd4 107e YES 43
3f fd5 107e YES 42
3f fd6 107e YES 41
3f fd7 107e YES 40
3f fd8 107e YES 39
3f fd9 107e YES 38
3f fda 107e YES 37
3f fdb 107e YES 36
3f fdc 107e YES 35
3f fdd 107e YES 34
3f fde 107e YES 33
3f fdf 107e YES 32
3f fe0 107e YES 31
3f fe1 107e YES 30
3f fe2 107e YES 29
3f fe3 107e YES 28
3f fe4 107e YES 27
3f fe5 107e YES 26
3f fe6 107e YES 25
3f fe7 107e YES 24
3f fe8 107e YES 23
3f fe9 107e YES 22
3f fea 107e YES 21
3f feb 107e YES 20
3f fec 107e YES 19
3f fed 107e YES 18
3f fee 107e YES 17
3f fef 107e YES 16
3f ff0 107e YES 15
3f ff1 107e YES 14
3f ff2 107e YES 13
3f ff3 107e YES 12
3f ff4 107e YES 11
3f ff5 107e YES 10
3f ff6 107e YES 9
3f ff7 107e YES 8
3f ff8 107e YES 7
3f ff9 107e YES 6
3f ffa 107e YES 5
3f ffb 107e YES 4
3f ffc 107e YES 3
3f ffd 107e YES 2
3f ffe 107e YES 1
3f fff 107e YES 1
3f 1000 107e YES 126
3f 1001 107e YES 125
3f 1002 107e YES 124
3f 1003 107e YES 123
3f 1004 107e YES 122
3f 1005 107e YES 121
3f 1006 107e YES 120
3f 1007 107e YES 119
3f 1008 107e YES 118
3f 1009 107e YES 117
3f 100a 107e YES 116
3f 100b 107e YES 115
3f 100c 107e YES 114
3f 100d 107e YES 113
3f 100e 107e YES 112
3f 100f 107e YES 111
3f 1010 107e YES 110
3f 1011 107e YES 109
3f 1012 107e YES 108
3f 1013 107e YES 107
3f 1014 107e YES 106
3f 1015 107e YES 105
3f 1016 107e YES 104
3f 1017 107e YES 103
3f 1018 107e YES 102
3f 1019 107e YES 101
3f 101a 107e YES 100
3f 101b 107e YES 99
3f 101c 107e YES 98
3f 101d 107e YES 97
3f 101e 107e YES 96
3f 101f 107e YES 95
3f 1020 107e YES 94
3f 1021 107e YES 93
3f 1022 107e YES 92
3f 1023 107e YES 91
3f 1024 107e YES 90
3f 1025 107e YES 89
3f 1026 107e YES 88
3f 1027 107e YES 87
3f 1028 107e YES 86
3f 1029 107e YES 85
3f 102a 107e YES 84
3f 102b 107e YES 83
3f 102c 107e YES 82
3f 102d 107e YES 81
3f 102e 107e YES 80
3f 102f 107e YES 79
3f 1030 107e YES 78
3f 1031 107e YES 77
3f 1032 107e YES 76
3f 1033 107e YES 75
3f 1034 107e YES 74
3f 1035 107e YES 73
3f 1036 107e YES 72
3f 1037 107e YES 71
3f 1038 107e YES 70
3f 1039 107e YES 69
3f 103a 107e YES 68
3f 103b 107e YES 67
3f 103c 107e YES 66
3f 103d 107e YES 65
3f 103e 107e YES 64
3f 103f 107e YES 63
3f 1040 107e YES 62
3f 1041 107e YES 61
3f 1042 107e YES 60
3f 1043 107e YES 59
3f 1044 107e YES 58
3f 1045 107e YES 57
3f 1046 107e YES 56
3f 1047 107e YES 55
3f 1048 107e YES 54
3f 1049 107e YES 53
3f 104a 107e YES 52
3f 104b 107e YES 51
3f 104c 107e YES 50
3f 104d 107e YES 49
3f 104e 107e YES 48
3f 104f 107e YES 47
3f 1050 107e YES 46
3f 1051 107e YES 45
3f 1052 107e YES 44
3f 1053 107e YES 43
3f 1054 107e YES 42
3f 1055 107e YES 41
3f 1056 107e YES 40
3f 1057 107e YES 39
3f 1058 107e YES 38
3f 1059 107e YES 37
3f 105a 107e YES 36
3f 105b 107e YES 35
3f 105c 107e YES 34
3f 105d 107e YES 33
3f 105e 107e YES 32
3f 105f 107e YES 31
3f 1060 107e YES 30
3f 1061 107e YES 29
3f 1062 107e YES 28
3f 1063 107e YES 27
3f 1064 107e YES 26
3f 1065 107e YES 25
3f 1066 107e YES 24
3f 1067 107e YES 23
3f 1068 107e YES 22
3f 1069 107e YES 21
3f 106a 107e YES 20
3f 106b 107e YES 19
3f 106c 107e YES 18
3f 106d 107e YES 17
3f 106e 107e YES 16
3f 106f 107e YES 15
3f 1070 107e YES 14
3f 1071 107e YES 13
3f 1072 107e YES 12
3f 1073 107e YES 11
3f 1074 107e YES 10
3f 1075 107e YES 9
3f 1076 107e YES 8
3f 1077 107e YES 7
3f 1078 107e YES 6
3f 1079 107e YES 5
3f 107a 107e YES 4
3f 107b 107e YES 3
3f 107c 107e YES 2
3f 107d 107e YES 1
```